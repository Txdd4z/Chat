<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title></title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            background: #000000;
            color: #ffffff;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            height: 100vh;
            overflow: hidden;
            touch-action: manipulation;
        }
        
        #tela-entrada {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .container-entrada {
            background: #111111;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 320px;
            border: 1px solid #222222;
        }
        
        #input-codigo {
            width: 100%;
            padding: 16px;
            margin: 15px 0;
            border-radius: 8px;
            border: 2px solid #333333;
            background: #222222;
            color: #ffffff;
            font-size: 16px;
            text-align: center;
            letter-spacing: 2px;
            outline: none;
        }
        
        #input-codigo:focus {
            border-color: #0a84ff;
        }
        
        #btn-acessar {
            width: 100%;
            padding: 16px;
            background: #0a84ff;
            border: none;
            border-radius: 8px;
            color: #ffffff;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        #btn-acessar:active {
            background: #007aff;
        }
        
        #area-principal {
            display: none;
            height: 100vh;
            flex-direction: column;
        }
        
        .topo {
            background: #111111;
            padding: 12px 16px;
            border-bottom: 1px solid #222222;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .indicador {
            width: 8px;
            height: 8px;
            background: #30d158;
            border-radius: 50%;
        }
        
        .conversas {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            background: #000000;
        }
        
        .msg {
            margin: 8px 0;
            padding: 12px 16px;
            border-radius: 18px;
            max-width: 85%;
            word-wrap: break-word;
            line-height: 1.4;
        }
        
        .msg.local {
            background: #0a84ff;
            margin-left: auto;
            border-bottom-right-radius: 4px;
        }
        
        .msg.remota {
            background: #1c1c1e;
            margin-right: auto;
            border-bottom-left-radius: 4px;
            border: 1px solid #2c2c2e;
        }
        
        .entrada {
            background: #111111;
            padding: 12px 16px;
            border-top: 1px solid #222222;
            display: flex;
            gap: 10px;
        }
        
        #input-msg {
            flex: 1;
            padding: 12px 16px;
            border-radius: 20px;
            border: 1px solid #333333;
            background: #222222;
            color: #ffffff;
            font-size: 16px;
            outline: none;
        }
        
        #input-msg:focus {
            border-color: #0a84ff;
        }
        
        #btn-enviar {
            background: #0a84ff;
            border: none;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            color: #ffffff;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .digitando {
            padding: 8px 16px;
            color: #8e8e93;
            font-size: 14px;
            font-style: italic;
            display: none;
        }
        
        .conversas::-webkit-scrollbar {
            width: 0;
            background: transparent;
        }
        
        @keyframes entrada {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .msg {
            animation: entrada 0.2s ease-out;
        }
    </style>
</head>
<body>
    <div id="tela-entrada">
        <div class="container-entrada">
            <input type="password" id="input-codigo" placeholder="••••" autocomplete="off" maxlength="4">
            <button id="btn-acessar">→</button>
        </div>
    </div>
    
    <div id="area-principal">
        <div class="topo">
            <div class="indicador"></div>
            <div style="font-size: 14px; color: #8e8e93;">•</div>
        </div>
        
        <div class="conversas" id="conversas">
            <div class="msg remota">
                •
            </div>
        </div>
        
        <div class="digitando" id="digitando">
            <span id="texto-digitando"></span>
        </div>
        
        <div class="entrada">
            <input type="text" id="input-msg" placeholder="•" autocomplete="off">
            <button id="btn-enviar">→</button>
        </div>
    </div>

<script>
// Firebase
const firebaseConfig = {
    databaseURL: "https://chat-5d4cd-default-rtdb.firebaseio.com/"
};

firebase.initializeApp(firebaseConfig);
const database = firebase.database();

document.addEventListener('DOMContentLoaded', function() {
    const telaEntrada = document.getElementById('tela-entrada');
    const areaPrincipal = document.getElementById('area-principal');
    const inputCodigo = document.getElementById('input-codigo');
    const btnAcessar = document.getElementById('btn-acessar');
    const inputMsg = document.getElementById('input-msg');
    const btnEnviar = document.getElementById('btn-enviar');
    const conversas = document.getElementById('conversas');
    const digitando = document.getElementById('digitando');
    const textoDigitando = document.getElementById('texto-digitando');
    
    let idUsuario = '';
    let digitandoAtivo = false;
    let timeoutDigitando;
    
    // Acesso
    function acessar() {
        const codigo = inputCodigo.value;
        const codigos = ['0306', '0000', '1234', '1111', '2222', '3333'];
        
        if (codigos.includes(codigo)) {
            idUsuario = 'u_' + Date.now() + Math.random().toString(36).substr(2, 6);
            
            telaEntrada.style.opacity = '0';
            
            setTimeout(() => {
                telaEntrada.style.display = 'none';
                areaPrincipal.style.display = 'flex';
                
                setTimeout(() => {
                    inputMsg.focus();
                }, 100);
                
                conectar();
            }, 300);
        } else {
            inputCodigo.style.borderColor = '#ff453a';
            inputCodigo.value = '';
            inputCodigo.placeholder = '••••';
            
            setTimeout(() => {
                inputCodigo.style.borderColor = '';
            }, 1000);
        }
    }
    
    // Conexão
    function conectar() {
        // Presença
        database.ref('presenca/' + idUsuario).set({
            t: Date.now()
        });
        
        window.addEventListener('beforeunload', () => {
            database.ref('presenca/' + idUsuario).remove();
        });
        
        // Remover inativos
        database.ref('presenca').on('value', (snapshot) => {
            const agora = Date.now();
            const dados = snapshot.val();
            
            if (dados) {
                Object.entries(dados).forEach(([id, info]) => {
                    if (agora - info.t > 30000) {
                        database.ref('presenca/' + id).remove();
                    }
                });
            }
        });
        
        // Ouvir mensagens
        database.ref('mensagens').limitToLast(1).on('child_added', (snapshot) => {
            const dados = snapshot.val();
            
            if (dados && dados.id !== idUsuario) {
                adicionarMensagem(dados.txt, false);
                
                // Notificação
                if (document.hidden) {
                    document.title = '•';
                    
                    setTimeout(() => {
                        document.title = '';
                    }, 1000);
                }
            }
        });
        
        // Ouvir digitação
        database.ref('digitando').on('value', (snapshot) => {
            const dados = snapshot.val();
            let alguemDigitando = false;
            
            if (dados) {
                Object.entries(dados).forEach(([id, info]) => {
                    if (id !== idUsuario && info.a) {
                        alguemDigitando = true;
                        textoDigitando.textContent = '•';
                    }
                });
            }
            
            digitando.style.display = alguemDigitando ? 'block' : 'none';
        });
        
        // Limpar mensagens antigas periodicamente
        setInterval(() => {
            database.ref('mensagens').remove();
        }, 3600000); // 1 hora
    }
    
    // Mensagem
    function adicionarMensagem(texto, local) {
        const msg = document.createElement('div');
        msg.className = `msg ${local ? 'local' : 'remota'}`;
        msg.textContent = texto;
        
        conversas.appendChild(msg);
        conversas.scrollTop = conversas.scrollHeight;
    }
    
    function enviar() {
        const texto = inputMsg.value.trim();
        if (!texto) return;
        
        // Salvar temporariamente
        database.ref('mensagens').push({
            txt: texto,
            id: idUsuario,
            t: Date.now()
        });
        
        // Mostrar localmente
        adicionarMensagem(texto, true);
        
        // Limpar
        inputMsg.value = '';
        
        // Parar digitação
        database.ref('digitando/' + idUsuario).remove();
        digitandoAtivo = false;
        clearTimeout(timeoutDigitando);
        
        // Foco
        inputMsg.focus();
    }
    
    // Detectar digitação
    inputMsg.addEventListener('input', function() {
        if (!digitandoAtivo) {
            digitandoAtivo = true;
            database.ref('digitando/' + idUsuario).set({
                a: true,
                t: Date.now()
            });
        }
        
        clearTimeout(timeoutDigitando);
        timeoutDigitando = setTimeout(() => {
            database.ref('digitando/' + idUsuario).remove();
            digitandoAtivo = false;
        }, 1500);
    });
    
    // Eventos
    btnAcessar.addEventListener('click', acessar);
    inputCodigo.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') acessar();
    });
    
    btnEnviar.addEventListener('click', enviar);
    inputMsg.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            enviar();
        }
    });
    
    // Foco inicial
    inputCodigo.focus();
    
    // Auto-limpeza ao iniciar
    setTimeout(() => {
        database.ref('mensagens').remove();
    }, 1000);
});
</script>
</body>
</html>
