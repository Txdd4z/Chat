<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title></title>
    <!-- Firebase v9.6.1 (vers√£o est√°vel) -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            background: #000000;
            color: #ffffff;
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            height: 100vh;
            overflow: hidden;
        }
        
        /* TELA DE SENHA */
        #screen-lock {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000000;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .lock-box {
            background: #111111;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 300px;
            text-align: center;
            border: 1px solid #333333;
        }
        
        #lock-input {
            width: 100%;
            padding: 15px;
            margin: 15px 0;
            border-radius: 8px;
            border: 2px solid #333333;
            background: #222222;
            color: white;
            font-size: 18px;
            text-align: center;
            outline: none;
        }
        
        #lock-btn {
            width: 100%;
            padding: 15px;
            background: #007AFF;
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
        }
        
        /* √ÅREA DO CHAT */
        #screen-chat {
            display: none;
            height: 100vh;
            flex-direction: column;
        }
        
        .chat-header {
            background: #111111;
            padding: 15px;
            border-bottom: 1px solid #333333;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            background: #34C759;
            border-radius: 50%;
        }
        
        .chat-messages {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            background: #000000;
        }
        
        .message {
            margin: 8px 0;
            padding: 12px 15px;
            border-radius: 18px;
            max-width: 85%;
            word-wrap: break-word;
        }
        
        .message.you {
            background: #007AFF;
            margin-left: auto;
        }
        
        .message.other {
            background: #333333;
            margin-right: auto;
            border: 1px solid #444444;
        }
        
        .chat-input {
            background: #111111;
            padding: 15px;
            border-top: 1px solid #333333;
            display: flex;
            gap: 10px;
        }
        
        #chat-input {
            flex: 1;
            padding: 12px;
            border-radius: 20px;
            border: 1px solid #333333;
            background: #222222;
            color: white;
            font-size: 16px;
            outline: none;
        }
        
        #send-btn {
            background: #007AFF;
            border: none;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            color: white;
            font-size: 18px;
            cursor: pointer;
        }
        
        .typing {
            padding: 5px 15px;
            color: #888888;
            font-size: 14px;
            font-style: italic;
            display: none;
        }
        
        /* Esconde scrollbar */
        .chat-messages::-webkit-scrollbar {
            width: 0;
            background: transparent;
        }
    </style>
</head>
<body>
    <!-- TELA DE SENHA -->
    <div id="screen-lock">
        <div class="lock-box">
            <div style="font-size: 24px; margin-bottom: 10px;">üîí</div>
            <input type="password" id="lock-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="off">
            <button id="lock-btn">‚Üí</button>
        </div>
    </div>
    
    <!-- √ÅREA DO CHAT -->
    <div id="screen-chat">
        <div class="chat-header">
            <div class="status-dot"></div>
            <div style="font-size: 14px; color: #888888;">‚Ä¢</div>
        </div>
        
        <div class="chat-messages" id="chat-messages">
            <div class="message other">
                ‚Ä¢
            </div>
        </div>
        
        <div class="typing" id="typing-indicator">
            <span id="typing-text">‚Ä¢</span>
        </div>
        
        <div class="chat-input">
            <input type="text" id="chat-input" placeholder="‚Ä¢" autocomplete="off" disabled>
            <button id="send-btn" disabled>‚Üí</button>
        </div>
    </div>

<script>
// CONFIGURA√á√ÉO FIREBASE SIMPLES
const firebaseConfig = {
    databaseURL: "https://chat-5d4cd-default-rtdb.firebaseio.com"
};

// INICIALIZA√á√ÉO FIREBASE
try {
    firebase.initializeApp(firebaseConfig);
    console.log("‚úÖ Firebase conectado");
} catch (error) {
    console.log("‚ùå Erro Firebase:", error);
}

const database = firebase.database();

// FUN√á√ïES PRINCIPAIS
document.addEventListener('DOMContentLoaded', function() {
    // Elementos HTML
    const screenLock = document.getElementById('screen-lock');
    const screenChat = document.getElementById('screen-chat');
    const lockInput = document.getElementById('lock-input');
    const lockBtn = document.getElementById('lock-btn');
    const chatInput = document.getElementById('chat-input');
    const sendBtn = document.getElementById('send-btn');
    const chatMessages = document.getElementById('chat-messages');
    const typingIndicator = document.getElementById('typing-indicator');
    const typingText = document.getElementById('typing-text');
    
    // Vari√°veis
    let userId = '';
    let isTyping = false;
    let typingTimeout = null;
    
    // ========== FUN√á√ÉO LOGIN ==========
    function login() {
        const password = lockInput.value.trim();
        
        // Senhas v√°lidas
        const validPasswords = ['0306', '1234', '0000', '1111', '2222', '3333'];
        
        if (validPasswords.includes(password)) {
            // Gera ID √∫nico para usu√°rio
            userId = 'user_' + Date.now() + '_' + Math.floor(Math.random() * 1000);
            
            // Efeito visual de entrada
            lockBtn.textContent = '‚úì';
            lockBtn.style.background = '#34C759';
            
            setTimeout(() => {
                // Esconde tela de senha
                screenLock.style.opacity = '0';
                screenLock.style.transition = 'opacity 0.3s';
                
                setTimeout(() => {
                    screenLock.style.display = 'none';
                    screenChat.style.display = 'flex';
                    
                    // Habilita chat
                    chatInput.disabled = false;
                    sendBtn.disabled = false;
                    
                    // Foco no input
                    setTimeout(() => {
                        chatInput.focus();
                    }, 100);
                    
                    // Conecta ao Firebase
                    connectToFirebase();
                    
                }, 300);
                
            }, 200);
            
        } else {
            // Senha incorreta
            lockInput.style.borderColor = '#FF3B30';
            lockInput.value = '';
            lockInput.placeholder = '‚Ä¢';
            
            setTimeout(() => {
                lockInput.style.borderColor = '#333333';
                setTimeout(() => {
                    lockInput.placeholder = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
                }, 300);
            }, 800);
        }
    }
    
    // ========== CONEX√ÉO FIREBASE ==========
    function connectToFirebase() {
        try {
            // 1. Marcar como online
            database.ref('users/' + userId).set({
                online: true,
                lastSeen: Date.now()
            });
            
            // Remove quando sair
            window.addEventListener('beforeunload', function() {
                database.ref('users/' + userId).remove();
            });
            
            // 2. Carregar mensagens antigas
            loadMessages();
            
            // 3. Ouvir novas mensagens
            listenForMessages();
            
            // 4. Ouvir digita√ß√£o
            listenForTyping();
            
            console.log("‚úÖ Firebase conectado com sucesso");
            
        } catch (error) {
            console.log("‚ùå Erro ao conectar Firebase:", error);
        }
    }
    
    // ========== CARREGAR MENSAGENS ==========
    function loadMessages() {
        database.ref('messages').limitToLast(20).once('value')
            .then((snapshot) => {
                const messages = snapshot.val();
                if (messages) {
                    // Limpa mensagem inicial
                    chatMessages.innerHTML = '';
                    
                    // Mostra mensagens
                    Object.values(messages).forEach(msg => {
                        const isYou = msg.userId === userId;
                        addMessage(msg.text, isYou);
                    });
                }
            })
            .catch(error => {
                console.log("‚ùå Erro ao carregar mensagens:", error);
            });
    }
    
    // ========== OUVIR NOVAS MENSAGENS ==========
    function listenForMessages() {
        database.ref('messages').limitToLast(1).on('child_added', (snapshot) => {
            try {
                const msg = snapshot.val();
                if (msg && msg.userId !== userId) {
                    addMessage(msg.text, false);
                    
                    // Notifica√ß√£o
                    if (document.hidden) {
                        document.title = 'üí¨ ‚Ä¢';
                        setTimeout(() => {
                            document.title = '';
                        }, 1000);
                    }
                }
            } catch (error) {
                console.log("‚ùå Erro ao receber mensagem:", error);
            }
        });
    }
    
    // ========== OUVIR DIGITA√á√ÉO ==========
    function listenForTyping() {
        database.ref('typing').on('value', (snapshot) => {
            try {
                const typingData = snapshot.val();
                let someoneTyping = false;
                
                if (typingData) {
                    Object.entries(typingData).forEach(([id, data]) => {
                        if (id !== userId && data && data.typing) {
                            someoneTyping = true;
                        }
                    });
                }
                
                if (someoneTyping) {
                    typingIndicator.style.display = 'block';
                } else {
                    typingIndicator.style.display = 'none';
                }
                
            } catch (error) {
                console.log("‚ùå Erro digita√ß√£o:", error);
            }
        });
    }
    
    // ========== ADICIONAR MENSAGEM ==========
    function addMessage(text, isYou) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${isYou ? 'you' : 'other'}`;
        messageDiv.textContent = text;
        
        chatMessages.appendChild(messageDiv);
        
        // Scroll autom√°tico
        setTimeout(() => {
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }, 10);
    }
    
    // ========== ENVIAR MENSAGEM ==========
    function sendMessage() {
        const text = chatInput.value.trim();
        if (!text) return;
        
        try {
            // Salva no Firebase
            database.ref('messages').push({
                text: text,
                userId: userId,
                timestamp: Date.now()
            })
            .then(() => {
                // Mostra localmente
                addMessage(text, true);
                
                // Limpa input
                chatInput.value = '';
                
                // Para digita√ß√£o
                database.ref('typing/' + userId).remove();
                isTyping = false;
                clearTimeout(typingTimeout);
                
                // Foco
                chatInput.focus();
            })
            .catch(error => {
                console.log("‚ùå Erro ao enviar:", error);
                // Fallback: mostra mesmo com erro
                addMessage(text, true);
                chatInput.value = '';
                chatInput.focus();
            });
            
        } catch (error) {
            console.log("‚ùå Erro enviar:", error);
            addMessage(text, true);
            chatInput.value = '';
            chatInput.focus();
        }
    }
    
    // ========== DETECTAR DIGITA√á√ÉO ==========
    chatInput.addEventListener('input', function() {
        if (!isTyping) {
            isTyping = true;
            database.ref('typing/' + userId).set({
                typing: true,
                timestamp: Date.now()
            });
        }
        
        clearTimeout(typingTimeout);
        typingTimeout = setTimeout(() => {
            database.ref('typing/' + userId).remove();
            isTyping = false;
        }, 1500);
    });
    
    // ========== EVENT LISTENERS ==========
    
    // Login com bot√£o
    lockBtn.addEventListener('click', login);
    
    // Login com Enter
    lockInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            login();
        }
    });
    
    // Enviar com bot√£o
    sendBtn.addEventListener('click', sendMessage);
    
    // Enviar com Enter
    chatInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            sendMessage();
        }
    });
    
    // Foco inicial
    lockInput.focus();
    
    // Auto-limpeza peri√≥dica
    setInterval(() => {
        database.ref('messages').once('value')
            .then(snapshot => {
                const messages = snapshot.val();
                if (messages && Object.keys(messages).length > 50) {
                    // Mant√©m apenas √∫ltimas 50 mensagens
                    const allKeys = Object.keys(messages);
                    const toKeep = allKeys.slice(-50);
                    
                    allKeys.forEach(key => {
                        if (!toKeep.includes(key)) {
                            database.ref('messages/' + key).remove();
                        }
                    });
                }
            });
    }, 60000); // A cada 1 minuto
});
</script>
</body>
</html>
